{% extends "base.html" %}

{% block title %}AI Journal - Enhanced - Aarohan{% endblock %}

{% block head %}
<!-- Quill Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<!-- Chart.js for Mood Tracking -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Flatpickr for Calendar -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Web Speech API Polyfill -->
<script src="https://cdn.jsdelivr.net/gh/microsoft/cognitive-services-speech-sdk-js@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>

<style>
/* Enhanced Journal Styles */
.journal-container {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
}

.rich-editor {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 16px;
    min-height: 300px;
}

.dark .rich-editor {
    background: rgba(30, 41, 59, 0.95);
    color: #f8f9fa;
}

.ql-toolbar {
    border-radius: 16px 16px 0 0;
    border: none;
    background: rgba(16, 185, 129, 0.1);
}

.ql-container {
    border: none;
    border-radius: 0 0 16px 16px;
    font-size: 16px;
    font-family: 'Nunito', sans-serif;
}

/* Streak Graph Styles */
.streak-graph {
    display: grid;
    grid-template-columns: repeat(53, 1fr);
    gap: 3px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    backdrop-filter: blur(10px);
}

.streak-day {
    width: 12px;
    height: 12px;
    border-radius: 3px;
    background: rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
    cursor: pointer;
}

.streak-day:hover {
    transform: scale(1.2);
}

.streak-day.level-0 { background: rgba(255, 255, 255, 0.1); }
.streak-day.level-1 { background: rgba(16, 185, 129, 0.3); }
.streak-day.level-2 { background: rgba(16, 185, 129, 0.6); }
.streak-day.level-3 { background: rgba(16, 185, 129, 0.8); }
.streak-day.level-4 { background: rgba(16, 185, 129, 1); }

/* Badge Styles */
.milestone-badge {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    background: linear-gradient(135deg, #10b981, #059669);
    border-radius: 20px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    animation: pulse-gentle 2s infinite;
}

@keyframes pulse-gentle {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

/* Tag Styles */
.tag-input {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 12px;
    padding: 8px 12px;
    color: white;
    font-size: 14px;
}

.tag-chip {
    display: inline-block;
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 500;
    margin: 2px;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.tag-chip .remove {
    margin-left: 8px;
    cursor: pointer;
    font-weight: bold;
}

/* Voice Recording Styles */
.voice-recorder {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.record-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.record-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
}

.record-btn.recording {
    animation: pulse-record 1s infinite;
    background: linear-gradient(135deg, #dc2626, #991b1b);
}

@keyframes pulse-record {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Calendar Styles */
.calendar-container {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    padding: 20px;
    backdrop-filter: blur(10px);
}

.flatpickr-calendar {
    background: rgba(30, 41, 59, 0.95) !important;
    border-radius: 16px !important;
    border: 1px solid rgba(16, 185, 129, 0.3) !important;
}

.flatpickr-day.hasEntry {
    background: rgba(16, 185, 129, 0.3) !important;
    border-radius: 50% !important;
}

/* Mood Chart Styles */
.mood-chart-container {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    padding: 20px;
    backdrop-filter: blur(10px);
}

/* Entry Card Styles */
.entry-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.entry-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    background: rgba(255, 255, 255, 0.08);
}

/* Emotion Indicator */
.emotion-indicator {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    font-size: 14px;
}

/* Search and Filter Styles */
.search-filter {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    padding: 20px;
    backdrop-filter: blur(10px);
    margin-bottom: 20px;
}

.filter-btn {
    padding: 8px 16px;
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 20px;
    color: #10b981;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 4px;
}

.filter-btn:hover, .filter-btn.active {
    background: rgba(16, 185, 129, 0.3);
    transform: translateY(-2px);
}

/* Responsive Design */
@media (max-width: 768px) {
    .streak-graph {
        grid-template-columns: repeat(26, 1fr);
        gap: 2px;
    }
    
    .streak-day {
        width: 10px;
        height: 10px;
    }
    
    .record-btn {
        width: 50px;
        height: 50px;
        font-size: 20px;
    }
}

/* Loading States */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 16px;
    backdrop-filter: blur(4px);
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(16, 185, 129, 0.3);
    border-top: 4px solid #10b981;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Privacy Lock Styles */
.privacy-lock {
    text-align: center;
    padding: 40px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    backdrop-filter: blur(10px);
}

.lock-icon {
    font-size: 48px;
    color: #10b981;
    margin-bottom: 16px;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900/80 via-slate-800/70 to-slate-900/80 backdrop-blur-sm">
    <div class="absolute inset-0 bg-gradient-to-r from-green-900/10 to-blue-900/10"></div>
    <div class="relative max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        
        <!-- Privacy Lock Screen -->
        <div id="privacyLock" class="hidden privacy-lock">
            <div class="lock-icon">üîí</div>
            <h2 class="text-2xl font-bold text-white mb-4">Journal Protected</h2>
            <p class="text-gray-300 mb-6">Please verify your identity to access your private journal</p>
            <button onclick="unlockJournal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300">
                Unlock Journal
            </button>
        </div>

        <!-- Main Journal Interface -->
        <div id="journalInterface">
            <!-- Page Header with Stats -->
            <div class="text-center mb-8">
                <div class="mb-6">
                    <div class="w-20 h-20 bg-white/10 backdrop-blur-sm rounded-3xl mx-auto mb-4 flex items-center justify-center shadow-2xl">
                        <svg class="w-10 h-10 text-green-400" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                    </div>
                </div>
                <h1 class="text-4xl font-bold text-white mb-4">Enhanced AI Journal</h1>
                <p class="text-xl text-gray-300 max-w-3xl mx-auto mb-6">
                    Express your thoughts with rich formatting, voice notes, and intelligent insights
                </p>
                
                <!-- Quick Stats -->
                <div class="flex justify-center gap-6 flex-wrap">
                    <div class="bg-white/10 backdrop-blur-sm rounded-2xl px-6 py-3 border border-white/20">
                        <div class="text-2xl font-bold text-green-400" id="currentStreak">{{ streak_data.current_streak or 0 }}</div>
                        <div class="text-sm text-gray-300">Current Streak</div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm rounded-2xl px-6 py-3 border border-white/20">
                        <div class="text-2xl font-bold text-blue-400" id="longestStreak">{{ streak_data.longest_streak or 0 }}</div>
                        <div class="text-sm text-gray-300">Longest Streak</div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm rounded-2xl px-6 py-3 border border-white/20">
                        <div class="text-2xl font-bold text-purple-400" id="totalEntries">{{ streak_data.total_entries or 0 }}</div>
                        <div class="text-sm text-gray-300">Total Entries</div>
                    </div>
                </div>

                <!-- Milestone Badges -->
                <div id="milestoneBadges" class="mt-4 flex justify-center gap-2 flex-wrap">
                    <!-- Badges will be populated by JavaScript -->
                </div>
            </div>

            <!-- Streak Contribution Graph -->
            <div class="journal-container mb-8">
                <h3 class="text-xl font-bold text-white mb-4 px-6 pt-6">üìä Your Journaling Journey</h3>
                <div class="streak-graph" id="streakGraph">
                    <!-- Grid will be populated by JavaScript -->
                </div>
                <div class="px-6 pb-6 text-center">
                    <div class="flex justify-center items-center gap-4 text-sm text-gray-400 mt-4">
                        <span>Less</span>
                        <div class="flex gap-1">
                            <div class="streak-day level-0"></div>
                            <div class="streak-day level-1"></div>
                            <div class="streak-day level-2"></div>
                            <div class="streak-day level-3"></div>
                            <div class="streak-day level-4"></div>
                        </div>
                        <span>More</span>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                
                <!-- Journal Editor (Left - 2 columns) -->
                <div class="lg:col-span-2">
                    <div class="journal-container p-8">
                        <h2 class="text-2xl font-bold text-white mb-6">‚úçÔ∏è Today's Entry</h2>
                        
                        <!-- Entry Form -->
                        <form id="enhancedJournalForm" class="space-y-6">
                            
                            <!-- Rich Text Editor -->
                            <div>
                                <label class="block text-white font-semibold mb-3">Share your thoughts...</label>
                                <div id="richEditor" class="rich-editor"></div>
                                <div class="flex justify-between mt-2">
                                    <span class="text-sm text-gray-400">Rich formatting supported</span>
                                    <span id="wordCountRich" class="text-sm text-green-400">0 words</span>
                                </div>
                            </div>

                            <!-- Voice Recording -->
                            <div class="voice-recorder">
                                <button type="button" id="recordBtn" class="record-btn" title="Record Voice Note">
                                    üé§
                                </button>
                                <div class="flex-1">
                                    <div id="recordingStatus" class="text-white font-medium">Click to record a voice note</div>
                                    <div id="recordingTime" class="text-sm text-gray-400"></div>
                                </div>
                                <audio id="audioPlayback" controls class="hidden"></audio>
                            </div>

                            <!-- Tags Input -->
                            <div>
                                <label class="block text-white font-semibold mb-3">Tags</label>
                                <div class="flex flex-wrap gap-2 mb-2" id="tagsList"></div>
                                <input type="text" id="tagInput" class="tag-input w-full" 
                                       placeholder="Add tags (press Enter to add) - e.g., #gratitude #stress #dreams"
                                       onkeypress="handleTagInput(event)">
                            </div>

                            <!-- Quick Mood Selection -->
                            <div>
                                <label class="block text-white font-semibold mb-3">How are you feeling?</label>
                                <div class="grid grid-cols-5 gap-3">
                                    <button type="button" class="mood-btn p-4 bg-white/5 hover:bg-white/15 rounded-2xl border border-white/20 transition-all duration-300" data-mood="very_happy">
                                        <div class="text-4xl mb-2">üòÑ</div>
                                        <div class="text-xs text-gray-300">Joyful</div>
                                    </button>
                                    <button type="button" class="mood-btn p-4 bg-white/5 hover:bg-white/15 rounded-2xl border border-white/20 transition-all duration-300" data-mood="happy">
                                        <div class="text-4xl mb-2">üòä</div>
                                        <div class="text-xs text-gray-300">Happy</div>
                                    </button>
                                    <button type="button" class="mood-btn p-4 bg-white/5 hover:bg-white/15 rounded-2xl border border-white/20 transition-all duration-300" data-mood="neutral">
                                        <div class="text-4xl mb-2">üòê</div>
                                        <div class="text-xs text-gray-300">Neutral</div>
                                    </button>
                                    <button type="button" class="mood-btn p-4 bg-white/5 hover:bg-white/15 rounded-2xl border border-white/20 transition-all duration-300" data-mood="sad">
                                        <div class="text-4xl mb-2">üòî</div>
                                        <div class="text-xs text-gray-300">Sad</div>
                                    </button>
                                    <button type="button" class="mood-btn p-4 bg-white/5 hover:bg-white/15 rounded-2xl border border-white/20 transition-all duration-300" data-mood="anxious">
                                        <div class="text-4xl mb-2">üò∞</div>
                                        <div class="text-xs text-gray-300">Anxious</div>
                                    </button>
                                </div>
                                <input type="hidden" id="selectedMood" name="mood" value="">
                            </div>

                            <!-- Additional Context -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="energyLevel" class="block text-white font-semibold mb-2">Energy Level</label>
                                    <select id="energyLevel" name="energy_level" class="w-full p-3 bg-white/95 border border-green-400/30 rounded-xl text-gray-900">
                                        <option value="">Select energy level</option>
                                        <option value="very_low">‚ö° Very Low</option>
                                        <option value="low">‚ö°‚ö° Low</option>
                                        <option value="moderate">‚ö°‚ö°‚ö° Moderate</option>
                                        <option value="high">‚ö°‚ö°‚ö°‚ö° High</option>
                                        <option value="very_high">‚ö°‚ö°‚ö°‚ö°‚ö° Very High</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="sleepQuality" class="block text-white font-semibold mb-2">Sleep Quality</label>
                                    <select id="sleepQuality" name="sleep_quality" class="w-full p-3 bg-white/95 border border-green-400/30 rounded-xl text-gray-900">
                                        <option value="">How did you sleep?</option>
                                        <option value="very_poor">üò¥ Very Poor</option>
                                        <option value="poor">üò¥üò¥ Poor</option>
                                        <option value="fair">üò¥üò¥üò¥ Fair</option>
                                        <option value="good">üò¥üò¥üò¥üò¥ Good</option>
                                        <option value="excellent">üò¥üò¥üò¥üò¥üò¥ Excellent</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Save Button -->
                            <div class="flex justify-center pt-4">
                                <button type="submit" id="saveEntryBtn" class="group bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white font-bold py-4 px-8 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-2xl hover:shadow-green-500/25 border border-green-400/20 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <div class="flex items-center space-x-3">
                                        <svg class="w-5 h-5 group-hover:animate-pulse" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3M19,19H5V5H16V10H19V19Z"/>
                                        </svg>
                                        <span>Save Entry & Analyze</span>
                                    </div>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Sidebar (Right - 1 column) -->
                <div class="lg:col-span-1 space-y-6">
                    
                    <!-- AI Insights -->
                    <div class="journal-container p-6">
                        <h3 class="text-xl font-bold text-white mb-4">ü§ñ AI Insights</h3>
                        <div id="aiInsights">
                            <div class="text-center text-gray-400 py-8">
                                <svg class="w-12 h-12 mx-auto mb-3 opacity-50" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7A1,1 0 0,0 14,8H18A1,1 0 0,0 19,7V5.73C18.4,5.39 18,4.74 18,4A2,2 0 0,1 20,2A2,2 0 0,1 22,4C22,4.74 21.6,5.39 21,5.73V7A3,3 0 0,1 18,10H14A3,3 0 0,1 11,7V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2M7,9A2,2 0 0,1 9,11A2,2 0 0,1 7,13A2,2 0 0,1 5,11A2,2 0 0,1 7,9M10,15.5H14L13,13.5H11L10,15.5M12,16A3,3 0 0,1 15,19A3,3 0 0,1 12,22A3,3 0 0,1 9,19A3,3 0 0,1 12,16Z"/>
                                </svg>
                                <p class="text-sm">Write your journal entry to get AI insights</p>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar View -->
                    <div class="journal-container p-6">
                        <h3 class="text-xl font-bold text-white mb-4">üìÖ Calendar View</h3>
                        <div class="calendar-container">
                            <input type="text" id="calendarPicker" class="hidden">
                            <div id="calendarDisplay"></div>
                        </div>
                    </div>

                    <!-- Mood Trends -->
                    <div class="journal-container p-6">
                        <h3 class="text-xl font-bold text-white mb-4">üìà Mood Trends</h3>
                        <div class="mood-chart-container">
                            <canvas id="moodChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div class="search-filter">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex-1">
                        <input type="text" id="searchInput" placeholder="Search your entries..." 
                               class="w-full p-3 bg-white/95 border border-green-400/30 rounded-xl text-gray-900">
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="filter-btn active" data-filter="all">All Entries</button>
                        <button class="filter-btn" data-filter="today">Today</button>
                        <button class="filter-btn" data-filter="this_week">This Week</button>
                        <button class="filter-btn" data-filter="this_month">This Month</button>
                    </div>
                </div>
                <div id="tagFilters" class="mt-4 flex flex-wrap gap-2">
                    <!-- Tag filter buttons will be populated by JavaScript -->
                </div>
            </div>

            <!-- Journal Entries History -->
            <div class="journal-container p-8">
                <h2 class="text-2xl font-bold text-white mb-6">üìö Your Journal History</h2>
                <div id="journalHistory" class="space-y-4">
                    {% if journal_entries %}
                        {% for entry in journal_entries %}
                        <div class="entry-card" data-entry-id="{{ entry.id }}" data-tags="{{ entry.tags or '' }}" data-date="{{ entry.created_at }}">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center space-x-3">
                                    <span class="text-2xl">{{ entry.mood_emoji or 'üòê' }}</span>
                                    <div>
                                        <h4 class="font-semibold text-white">{{ entry.created_at.strftime('%B %d, %Y') }}</h4>
                                        <p class="text-sm text-gray-400">{{ entry.created_at.strftime('%I:%M %p') }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    {% if entry.emotion_detected %}
                                    <div class="emotion-indicator">
                                        <span>{{ entry.emotion_detected }}</span>
                                        <span class="text-xs">{{ "%.1f"|format(entry.sentiment_score or 0) }}</span>
                                    </div>
                                    {% endif %}
                                    <span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-xs font-medium">
                                        {{ entry.mood or 'No mood' }}
                                    </span>
                                </div>
                            </div>
                            
                            {% if entry.tags %}
                            <div class="mb-3">
                                {% for tag in entry.tags.split(',') %}
                                    <span class="tag-chip">{{ tag.strip() }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <div class="text-gray-300 text-sm mb-3 line-clamp-3">
                                {{ entry.content[:200] | safe }}{% if entry.content|length > 200 %}...{% endif %}
                            </div>
                            
                            {% if entry.voice_file_path %}
                            <div class="mb-3">
                                <audio controls class="w-full">
                                    <source src="{{ entry.voice_file_path }}" type="audio/wav">
                                    Your browser does not support the audio element.
                                </audio>
                            </div>
                            {% endif %}
                            
                            {% if entry.ai_insights %}
                            <div class="bg-purple-500/10 rounded-xl p-3 border border-purple-500/20">
                                <p class="text-purple-300 text-xs font-medium mb-1">ü§ñ AI Insights:</p>
                                <p class="text-purple-200 text-sm">{{ entry.ai_insights[:150] }}{% if entry.ai_insights|length > 150 %}...{% endif %}</p>
                            </div>
                            {% endif %}
                            
                            <div class="flex justify-between items-center mt-4 pt-3 border-t border-white/10">
                                <span class="text-xs text-gray-500">{{ entry.word_count or 0 }} words</span>
                                <div class="flex gap-2">
                                    <button onclick="editEntry({{ entry.id }})" class="text-blue-400 hover:text-blue-300 text-sm">Edit</button>
                                    <button onclick="deleteEntry({{ entry.id }})" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                            <p class="text-lg font-medium mb-2">No journal entries yet</p>
                            <p class="text-sm">Start writing your first entry above to begin your enhanced wellness journey</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white/10 backdrop-blur-sm rounded-3xl p-8 border border-white/20 text-center">
        <div class="spinner mx-auto mb-4"></div>
        <h3 class="text-xl font-semibold text-white mb-2">Processing Your Entry</h3>
        <p class="text-gray-300">Analyzing sentiment, saving data, and generating insights...</p>
    </div>
</div>

<script>
// Global variables
let quill;
let isRecording = false;
let mediaRecorder;
let audioChunks = [];
let recordingStartTime;
let recordingInterval;
let currentTags = [];
let streakData = [];
let moodChart;

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeRichEditor();
    initializeMoodSelection();
    initializeVoiceRecording();
    initializeCalendar();
    initializeStreakGraph();
    initializeMoodChart();
    initializeSearch();
    loadUserData();
});

// Rich Text Editor
function initializeRichEditor() {
    const toolbarOptions = [
        ['bold', 'italic', 'underline', 'strike'],
        ['blockquote', 'code-block'],
        [{ 'header': 1 }, { 'header': 2 }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'script': 'sub'}, { 'script': 'super' }],
        [{ 'indent': '-1'}, { 'indent': '+1' }],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'align': [] }],
        ['link', 'image'],
        ['clean']
    ];

    quill = new Quill('#richEditor', {
        theme: 'snow',
        modules: {
            toolbar: toolbarOptions
        },
        placeholder: 'What\'s on your mind today? Share your experiences, emotions, challenges, or victories...'
    });

    // Word count for rich editor
    quill.on('text-change', function() {
        const text = quill.getText().trim();
        const words = text ? text.split(/\s+/).length : 0;
        document.getElementById('wordCountRich').textContent = words + ' words';
    });
}

// Mood Selection
function initializeMoodSelection() {
    const moodButtons = document.querySelectorAll('.mood-btn');
    const selectedMoodInput = document.getElementById('selectedMood');
    
    moodButtons.forEach(button => {
        button.addEventListener('click', function() {
            moodButtons.forEach(btn => btn.classList.remove('bg-green-500/30', 'border-green-400'));
            this.classList.add('bg-green-500/30', 'border-green-400');
            selectedMoodInput.value = this.dataset.mood;
        });
    });
}

// Voice Recording
function initializeVoiceRecording() {
    const recordBtn = document.getElementById('recordBtn');
    const recordingStatus = document.getElementById('recordingStatus');
    const recordingTime = document.getElementById('recordingTime');
    const audioPlayback = document.getElementById('audioPlayback');

    recordBtn.addEventListener('click', function() {
        if (!isRecording) {
            startRecording();
        } else {
            stopRecording();
        }
    });

    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayback.src = audioUrl;
                audioPlayback.classList.remove('hidden');
                
                // Convert to text (placeholder - would need actual speech-to-text service)
                convertSpeechToText(audioBlob);
            };
            
            mediaRecorder.start();
            isRecording = true;
            recordBtn.classList.add('recording');
            recordBtn.innerHTML = '‚èπÔ∏è';
            recordingStatus.textContent = 'Recording in progress...';
            
            recordingStartTime = Date.now();
            recordingInterval = setInterval(updateRecordingTime, 1000);
            
        } catch (error) {
            console.error('Error accessing microphone:', error);
            alert('Error accessing microphone. Please check permissions.');
        }
    }
    
    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            
            isRecording = false;
            recordBtn.classList.remove('recording');
            recordBtn.innerHTML = 'üé§';
            recordingStatus.textContent = 'Recording saved! Click to record again.';
            
            clearInterval(recordingInterval);
            recordingTime.textContent = '';
        }
    }
    
    function updateRecordingTime() {
        if (recordingStartTime) {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            recordingTime.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
    }
    
    function convertSpeechToText(audioBlob) {
        // Placeholder for speech-to-text conversion
        // In a real implementation, you would send the audio to a speech-to-text service
        recordingStatus.textContent = 'Voice note recorded (speech-to-text requires API setup)';
    }
}

// Tag Management
function handleTagInput(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const input = event.target;
        const tag = input.value.trim();
        
        if (tag && !currentTags.includes(tag)) {
            currentTags.push(tag);
            updateTagsDisplay();
            input.value = '';
        }
    }
}

function updateTagsDisplay() {
    const tagsList = document.getElementById('tagsList');
    tagsList.innerHTML = '';
    
    currentTags.forEach(tag => {
        const tagElement = document.createElement('span');
        tagElement.className = 'tag-chip';
        tagElement.innerHTML = `${tag} <span class="remove" onclick="removeTag('${tag}')">&times;</span>`;
        tagsList.appendChild(tagElement);
    });
}

function removeTag(tag) {
    currentTags = currentTags.filter(t => t !== tag);
    updateTagsDisplay();
}

// Calendar Integration
function initializeCalendar() {
    const calendarPicker = document.getElementById('calendarPicker');
    
    flatpickr(calendarPicker, {
        inline: true,
        appendTo: document.getElementById('calendarDisplay'),
        onChange: function(selectedDates, dateStr, instance) {
            loadEntriesForDate(dateStr);
        },
        onDayCreate: function(dObj, dStr, fp, dayElem) {
            // Mark days with entries (placeholder logic)
            const random = Math.random();
            if (random > 0.7) {
                dayElem.classList.add('hasEntry');
            }
        }
    });
}

// Streak Graph
function initializeStreakGraph() {
    const streakGraph = document.getElementById('streakGraph');
    const today = new Date();
    const yearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
    
    // Generate 365 days
    for (let i = 0; i < 365; i++) {
        const day = document.createElement('div');
        day.className = 'streak-day level-' + Math.floor(Math.random() * 5);
        day.title = `${i} contributions on date`;
        streakGraph.appendChild(day);
    }
    
    updateMilestoneBadges();
}

function updateMilestoneBadges() {
    const badges = document.getElementById('milestoneBadges');
    const currentStreak = parseInt(document.getElementById('currentStreak').textContent);
    
    const milestones = [
        { days: 3, icon: 'üî•', text: '3-Day Streak' },
        { days: 7, icon: '‚≠ê', text: '1-Week Streak' },
        { days: 30, icon: 'üíé', text: '1-Month Streak' },
        { days: 100, icon: 'üëë', text: '100-Day Streak' }
    ];
    
    badges.innerHTML = '';
    milestones.forEach(milestone => {
        if (currentStreak >= milestone.days) {
            const badge = document.createElement('div');
            badge.className = 'milestone-badge';
            badge.innerHTML = `${milestone.icon} ${milestone.text}`;
            badges.appendChild(badge);
        }
    });
}

// Mood Chart
function initializeMoodChart() {
    const ctx = document.getElementById('moodChart').getContext('2d');
    
    moodChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Mood Score',
                data: [3.5, 4.2, 3.8, 4.5, 4.1, 3.9, 4.3],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 5,
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: 'rgba(156, 163, 175, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#9ca3af'
                    },
                    grid: {
                        color: 'rgba(156, 163, 175, 0.1)'
                    }
                }
            }
        }
    });
}

// Search and Filter
function initializeSearch() {
    const searchInput = document.getElementById('searchInput');
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    searchInput.addEventListener('input', filterEntries);
    
    filterButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            filterButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            filterEntries();
        });
    });
}

function filterEntries() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
    const entries = document.querySelectorAll('.entry-card');
    
    entries.forEach(entry => {
        const content = entry.textContent.toLowerCase();
        const entryDate = new Date(entry.dataset.date);
        const today = new Date();
        
        let showEntry = true;
        
        // Search filter
        if (searchTerm && !content.includes(searchTerm)) {
            showEntry = false;
        }
        
        // Date filter
        if (activeFilter === 'today') {
            showEntry = showEntry && entryDate.toDateString() === today.toDateString();
        } else if (activeFilter === 'this_week') {
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            showEntry = showEntry && entryDate > weekAgo;
        } else if (activeFilter === 'this_month') {
            showEntry = showEntry && entryDate.getMonth() === today.getMonth() && 
                       entryDate.getFullYear() === today.getFullYear();
        }
        
        entry.style.display = showEntry ? 'block' : 'none';
    });
}

// Form Submission
document.getElementById('enhancedJournalForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const content = quill.root.innerHTML;
    const textContent = quill.getText();
    
    if (!textContent.trim()) {
        alert('Please write something in your journal entry.');
        return;
    }
    
    const formData = new FormData();
    formData.append('journal_entry', content);
    formData.append('text_content', textContent);
    formData.append('mood', document.getElementById('selectedMood').value);
    formData.append('energy_level', document.getElementById('energyLevel').value);
    formData.append('sleep_quality', document.getElementById('sleepQuality').value);
    formData.append('tags', currentTags.join(','));
    formData.append('word_count', quill.getText().trim().split(/\s+/).length);
    
    // Show loading
    document.getElementById('loadingModal').classList.remove('hidden');
    document.getElementById('loadingModal').classList.add('flex');
    
    // Submit to backend
    fetch('/journal', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingModal').classList.add('hidden');
        document.getElementById('loadingModal').classList.remove('flex');
        
        if (data.success) {
            displayAIInsights(data.insights);
            showToast('Journal entry saved successfully!', 'success');
            
            // Reset form
            quill.setContents([]);
            document.getElementById('enhancedJournalForm').reset();
            currentTags = [];
            updateTagsDisplay();
            document.querySelectorAll('.mood-btn').forEach(btn => 
                btn.classList.remove('bg-green-500/30', 'border-green-400'));
            
            // Refresh page data
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showToast(data.message || 'Error saving entry. Please try again.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('loadingModal').classList.add('hidden');
        document.getElementById('loadingModal').classList.remove('flex');
        showToast('Network error. Please check your connection and try again.', 'error');
    });
});

// Utility Functions
function displayAIInsights(insights) {
    const aiInsightsContainer = document.getElementById('aiInsights');
    
    aiInsightsContainer.innerHTML = `
        <div class="bg-gradient-to-br from-purple-500/20 to-blue-500/20 rounded-2xl p-4 border border-purple-400/30">
            <h4 class="font-semibold text-purple-300 mb-3 flex items-center">
                <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7A1,1 0 0,0 14,8H18A1,1 0 0,0 19,7V5.73C18.4,5.39 18,4.74 18,4A2,2 0 0,1 20,2A2,2 0 0,1 22,4C22,4.74 21.6,5.39 21,5.73V7A3,3 0 0,1 18,10H14A3,3 0 0,1 11,7V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2M7,9A2,2 0 0,1 9,11A2,2 0 0,1 7,13A2,2 0 0,1 5,11A2,2 0 0,1 7,9M10,15.5H14L13,13.5H11L10,15.5M12,16A3,3 0 0,1 15,19A3,3 0 0,1 12,22A3,3 0 0,1 9,19A3,3 0 0,1 12,16Z"/>
                </svg>
                Mood Analysis
            </h4>
            <p class="text-purple-100 text-sm mb-3">${insights.mood_analysis || 'Your emotional state has been analyzed.'}</p>
            
            <h4 class="font-semibold text-green-300 mb-2 flex items-center">
                <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L21.79,2L24.62,4.83L9,20.42Z"/>
                </svg>
                Recommendations
            </h4>
            <p class="text-green-100 text-sm">${insights.recommendations || 'Keep up the great work with your mental wellness journey!'}</p>
        </div>
    `;
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    
    toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.remove('translate-x-full'), 100);
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => document.body.removeChild(toast), 300);
    }, 5000);
}

function loadUserData() {
    // Load streak data, mood trends, etc.
    // This would typically come from the backend
}

function loadEntriesForDate(dateStr) {
    // Load entries for specific date
    console.log('Loading entries for:', dateStr);
}

function editEntry(entryId) {
    // Edit functionality
    console.log('Editing entry:', entryId);
}

function deleteEntry(entryId) {
    if (confirm('Are you sure you want to delete this entry?')) {
        // Delete functionality
        console.log('Deleting entry:', entryId);
    }
}

function unlockJournal() {
    // Simple unlock mechanism (in real app, would use proper authentication)
    document.getElementById('privacyLock').classList.add('hidden');
    document.getElementById('journalInterface').classList.remove('hidden');
}

// Initialize privacy lock if needed
// Uncomment the line below to enable privacy lock by default
// document.getElementById('privacyLock').classList.remove('hidden');
</script>

{% endblock %}