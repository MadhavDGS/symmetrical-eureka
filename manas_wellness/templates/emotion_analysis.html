{% extends "base.html" %}

{% block title %}Emotion Analysis - Aarohan{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">
            <svg class="svg-icon-lg inline mr-2 text-purple-400" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
            </svg> Emotion Analysis
        </h1>
        <p class="text-lg text-gray-600">
            Share your feelings through text, voice, or camera. Our enhanced AI will help you understand your emotional state.
        </p>
    </div>
    
    <!-- Analysis Methods -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Text Analysis -->
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
            <div class="text-center">
                <div class="mb-4">
                    <svg class="svg-icon-xl mx-auto text-blue-500" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Text Analysis</h3>
                <p class="text-gray-600 text-sm mb-4">
                    Write about how you're feeling and let our AI analyze your emotions.
                </p>
                <button onclick="showTextAnalysis()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Start Writing
                </button>
            </div>
        </div>
        
        <!-- Voice Analysis -->
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
            <div class="text-center">
                <div class="mb-4">
                    <svg class="svg-icon-xl mx-auto text-green-500" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2c1.1 0 2 .9 2 2v6c0 1.1-.9 2-2 2s-2-.9-2-2V4c0-1.1.9-2 2-2zm5.3 6c-.08 0-.15.04-.2.1-.05.06-.08.14-.08.24v1.16c0 3.27-2.64 5.9-5.9 5.9s-5.9-2.63-5.9-5.9V8.34c0-.09-.04-.17-.1-.24-.06-.06-.13-.1-.21-.1-.08 0-.15.04-.21.1-.06.07-.1.15-.1.24v1.16C5 13.93 8.04 17.62 12 18v2h-4v2h8v-2h-4v-2c3.96-.38 7-4.07 7-8.5V8.34c0-.09-.04-.17-.1-.24-.06-.06-.13-.1-.21-.1z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Voice Analysis</h3>
                <p class="text-gray-600 text-sm mb-4">
                    Speak about your feelings and we'll analyze your voice patterns.
                </p>
                <button onclick="showVoiceAnalysis()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    Start Recording
                </button>
            </div>
        </div>
        
        <!-- Camera Analysis -->
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
            <div class="text-center">
                <div class="mb-4">
                    <svg class="svg-icon-xl mx-auto text-purple-500" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 3L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2h-3.17L15 3H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-9l1.25 2.75L16 13l-2.75 1.25L12 17l-1.25-2.75L8 13l2.75-1.25L12 9z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Facial Analysis</h3>
                <p class="text-gray-600 text-sm mb-4">
                    Use your camera to analyze facial expressions and emotions.
                </p>
                <button onclick="showCameraAnalysis()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                    Use Camera
                </button>
            </div>
        </div>
    </div>
    
    <!-- Analysis Interface -->
    <div id="analysis-interface" class="bg-white rounded-xl shadow-lg p-8 hidden">
        <!-- Text Analysis -->
        <div id="text-analysis" class="hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">
                <svg class="svg-icon inline mr-2 text-blue-500" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                </svg> Text Emotion Analysis
            </h2>
            
            <div class="space-y-6">
                <div>
                    <label for="emotion-text" class="block text-sm font-medium text-gray-700 mb-2">
                        How are you feeling? Share your thoughts...
                    </label>
                    <textarea id="emotion-text" 
                              rows="6" 
                              class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              placeholder="I'm feeling... Today has been... I'm worried about..."></textarea>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="analyzeText()" 
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                        üß† Analyze My Emotions
                    </button>
                    <button onclick="clearText()" 
                            class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                        üóëÔ∏è Clear Text
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Voice Analysis -->
        <div id="voice-analysis" class="hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">
                <svg class="svg-icon inline mr-2 text-green-500" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2c1.1 0 2 .9 2 2v6c0 1.1-.9 2-2 2s-2-.9-2-2V4c0-1.1.9-2 2-2zm5.3 6c-.08 0-.15.04-.2.1-.05.06-.08.14-.08.24v1.16c0 3.27-2.64 5.9-5.9 5.9s-5.9-2.63-5.9-5.9V8.34c0-.09-.04-.17-.1-.24-.06-.06-.13-.1-.21-.1-.08 0-.15.04-.21.1-.06.07-.1.15-.1.24v1.16C5 13.93 8.04 17.62 12 18v2h-4v2h8v-2h-4v-2c3.96-.38 7-4.07 7-8.5V8.34c0-.09-.04-.17-.1-.24-.06-.06-.13-.1-.21-.1z"/>
                </svg> Voice Emotion Analysis
            </h2>
            
            <div class="space-y-6">
                <div class="text-center">
                    <div id="recording-status" class="text-lg text-gray-600 mb-4">
                        Click the button below to start recording
                    </div>
                    
                    <div class="mb-6">
                        <button id="record-button" 
                                onclick="toggleRecording()" 
                                class="bg-green-600 text-white px-8 py-4 rounded-full hover:bg-green-700 transition-colors text-lg font-semibold">
                            <svg class="svg-icon inline mr-2" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2c1.1 0 2 .9 2 2v6c0 1.1-.9 2-2 2s-2-.9-2-2V4c0-1.1.9-2 2-2zm5.3 6c-.08 0-.15.04-.2.1-.05.06-.08.14-.08.24v1.16c0 3.27-2.64 5.9-5.9 5.9s-5.9-2.63-5.9-5.9V8.34c0-.09-.04-.17-.1-.24-.06-.06-.13-.1-.21-.1-.08 0-.15.04-.21.1-.06.07-.1.15-.1.24v1.16C5 13.93 8.04 17.62 12 18v2h-4v2h8v-2h-4v-2c3.96-.38 7-4.07 7-8.5V8.34c0-.09-.04-.17-.1-.24-.06-.06-.13-.1-.21-.1z"/>
                            </svg> üé§ Start Recording
                        </button>
                    </div>
                    
                    <div id="recording-timer" class="text-2xl font-mono text-gray-800 hidden">
                        00:00
                    </div>
                </div>
                
                <div id="audio-preview" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Recording Preview:</h3>
                    <audio id="audio-playback" controls class="w-full"></audio>
                    
                    <div class="mt-4 flex gap-4">
                        <button onclick="analyzeVoice()" 
                                class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                            üß† Analyze Voice
                        </button>
                        <button onclick="retryRecording()" 
                                class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                            üîÑ Record Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Camera Analysis -->
        <div id="camera-analysis" class="hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">
                <svg class="svg-icon inline mr-2 text-purple-500" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 3L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2h-3.17L15 3H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-9l1.25 2.75L16 13l-2.75 1.25L12 17l-1.25-2.75L8 13l2.75-1.25L12 9z"/>
                </svg> Enhanced Facial Emotion Analysis
            </h2>
            
            <div class="space-y-6">
                <div class="text-center">
                    <div id="camera-status" class="text-lg text-gray-600 mb-4">
                        Click the button below to start camera
                    </div>
                    
                    <div class="mb-6">
                        <video id="camera-feed" 
                               class="w-full max-w-md mx-auto rounded-lg border-2 border-gray-300 hidden" 
                               autoplay muted></video>
                        
                        <canvas id="capture-canvas" class="hidden"></canvas>
                        
                        <div id="camera-placeholder" class="w-full max-w-md mx-auto h-64 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center">
                            <div class="text-center">
                                <span class="text-4xl mb-2 block">üì∑</span>
                                <p class="text-gray-500">Camera preview will appear here</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="camera-button" 
                                onclick="toggleCamera()" 
                                class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors">
                            <svg class="svg-icon inline mr-2" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 3L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2h-3.17L15 3H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-9l1.25 2.75L16 13l-2.75 1.25L12 17l-1.25-2.75L8 13l2.75-1.25L12 9z"/>
                            </svg> üìπ Start Camera
                        </button>
                        <button id="capture-button" 
                                onclick="captureAndAnalyze()" 
                                class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors hidden">
                            <svg class="svg-icon inline mr-2" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 3L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2h-3.17L15 3H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-9l1.25 2.75L16 13l-2.75 1.25L12 17l-1.25-2.75L8 13l2.75-1.25L12 9z"/>
                            </svg> üì∏ Capture & Analyze
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Section -->
    <div id="loading-section" class="text-center py-12 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto mb-4"></div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">Analyzing Your Emotions...</h3>
        <p class="text-gray-600">Our enhanced AI is processing your input to provide personalized insights</p>
    </div>
    
    <!-- Enhanced Results Section -->
    <div id="results-section" class="mt-8 hidden">
        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">
                <svg class="svg-icon inline mr-2 text-indigo-500" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/>
                </svg> Enhanced Analysis Results
            </h2>
            
            <!-- Primary Emotion Display -->
            <div id="primary-emotion" class="text-center mb-8">
                <div class="w-32 h-32 bg-gray-200 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <span id="emotion-emoji" class="text-6xl">üòä</span>
                </div>
                <h3 id="emotion-name" class="text-3xl font-bold text-gray-900 mb-2">Happy</h3>
                <div class="flex items-center justify-center mb-4">
                    <span class="text-sm text-gray-600 mr-2">Intensity:</span>
                    <div class="w-48 bg-gray-200 rounded-full h-3">
                        <div id="intensity-bar" class="bg-green-500 h-3 rounded-full" style="width: 70%"></div>
                    </div>
                    <span id="intensity-value" class="text-sm text-gray-600 ml-2">7/10</span>
                </div>
                <div class="flex items-center justify-center">
                    <span class="text-sm text-gray-600 mr-2">Confidence:</span>
                    <span id="confidence-value" class="text-sm font-semibold text-green-600">85%</span>
                </div>
            </div>
            
            <!-- Emotion Breakdown -->
            <div id="emotion-breakdown" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <div id="results-content" class="space-y-6">
                <!-- Detailed Analysis -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Insights -->
                    <div class="bg-blue-50 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-blue-900 mb-4">üîç Detailed Insights</h4>
                        <div id="detailed-insights">
                            <p class="text-blue-800">Analysis will appear here...</p>
                        </div>
                    </div>
                    
                    <!-- Recommendations -->
                    <div class="bg-green-50 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-green-900 mb-4">üí° Recommendations</h4>
                        <div id="recommendations">
                            <p class="text-green-800">Personalized recommendations will appear here...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Cultural Context -->
                <div id="cultural-context" class="bg-purple-50 rounded-xl p-6">
                    <h4 class="text-lg font-semibold text-purple-900 mb-4">üåè Cultural Considerations</h4>
                    <div id="cultural-insights">
                        <p class="text-purple-800">Cultural context will be provided here...</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 flex flex-col sm:flex-row gap-4">
                <button onclick="getTherapyRecommendations()" 
                        class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors">
                    üßò Get Therapy Recommendations
                </button>
                <button onclick="saveResults()" 
                        class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                    üíæ Save to Dashboard
                </button>
                <button onclick="startNewAnalysis()" 
                        class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                    üîÑ New Analysis
                </button>
            </div>
        </div>
    </div>
    
    <!-- Privacy Notice -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start">
            <div class="mr-3">
                <svg class="svg-icon text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18,8h-1V6c0-2.76-2.24-5-5-5S7,3.24,7,6v2H6c-1.1,0-2,0.9-2,2v10c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2V10 C20,8.9,19.1,8,18,8z M12,17c-1.1,0-2-0.9-2-2s0.9-2,2-2s2,0.9,2,2S13.1,17,12,17z M15.1,8H8.9V6c0-1.71,1.39-3.1,3.1-3.1 s3.1,1.39,3.1,3.1V8z"/>
                </svg>
            </div>
            <div>
                <h3 class="text-sm font-semibold text-blue-800">Privacy & Security</h3>
                <p class="text-sm text-blue-700 mt-1">
                    Your emotional data is processed securely with enhanced AI analysis. You have full control over your data and can delete it at any time.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentAnalysisType = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let cameraStream = null;
    let recordingTimer = null;
    let recordingStartTime = null;
    let capturedPhotoBlob = null;
    
    // Emotion emoji mapping
    const emotionEmojis = {
        'happy': 'üòä',
        'sad': 'üò¢',
        'angry': 'üò†',
        'surprised': 'üò≤',
        'neutral': 'üòê',
        'anxious': 'üò∞',
        'confused': 'üòï',
        'excited': 'ü§©',
        'calm': 'üòå',
        'stressed': 'üò§'
    };
    
    // Show specific analysis interface
    function showTextAnalysis() {
        showAnalysisInterface('text');
    }
    
    function showVoiceAnalysis() {
        showAnalysisInterface('voice');
    }
    
    function showCameraAnalysis() {
        showAnalysisInterface('camera');
    }
    
    function showAnalysisInterface(type) {
        currentAnalysisType = type;
        
        // Hide all analysis types
        document.getElementById('text-analysis').classList.add('hidden');
        document.getElementById('voice-analysis').classList.add('hidden');
        document.getElementById('camera-analysis').classList.add('hidden');
        
        // Show selected type
        document.getElementById(type + '-analysis').classList.remove('hidden');
        
        // Show the interface
        document.getElementById('analysis-interface').classList.remove('hidden');
        
        // Scroll to interface
        document.getElementById('analysis-interface').scrollIntoView({ behavior: 'smooth' });
    }
    
    // Text Analysis Functions
    async function analyzeText() {
        const text = document.getElementById('emotion-text').value.trim();
        
        if (!text) {
            alert('Please enter some text to analyze');
            return;
        }
        
        showLoading();
        
        try {
            const response = await fetch('/api/emotion/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: text })
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayEnhancedResults(result.emotion_result, 'text');
            } else {
                throw new Error(result.error || 'Analysis failed');
            }
            
        } catch (error) {
            console.error('Text analysis error:', error);
            alert('Analysis failed: ' + error.message);
            hideLoading();
        }
    }
    
    function clearText() {
        document.getElementById('emotion-text').value = '';
    }
    
    // Voice Analysis Functions
    async function toggleRecording() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            stopRecording();
        } else {
            startRecording();
        }
    }
    
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            mediaRecorder = new MediaRecorder(stream);
            recordedChunks = [];
            
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = function() {
                const audioBlob = new Blob(recordedChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                document.getElementById('audio-playback').src = audioUrl;
                document.getElementById('audio-preview').classList.remove('hidden');
                
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            
            // Update UI
            document.getElementById('record-button').innerHTML = '<svg class="svg-icon inline mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg> ‚èπÔ∏è Stop Recording';
            document.getElementById('recording-status').textContent = 'Recording in progress...';
            document.getElementById('recording-timer').classList.remove('hidden');
            
            // Start timer
            recordingStartTime = Date.now();
            recordingTimer = setInterval(updateRecordingTimer, 1000);
            
        } catch (error) {
            console.error('Error starting recording:', error);
            alert('Unable to access microphone. Please check permissions and try again.');
        }
    }
    
    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            clearInterval(recordingTimer);
            
            // Update UI
            document.getElementById('record-button').innerHTML = '<svg class="svg-icon inline mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c1.1 0 2 .9 2 2v6c0 1.1-.9 2-2 2s-2-.9-2-2V4c0-1.1.9-2 2-2zm5.3 6c-.08 0-.15.04-.2.1-.05.06-.08.14-.08.24v1.16c0 3.27-2.64 5.9-5.9 5.9s-5.9-2.63-5.9-5.9V8.34c0-.09-.04-.17-.1-.24-.06-.06-.13-.1-.21-.1-.08 0-.15.04-.21.1-.06.07-.1.15-.1.24v1.16C5 13.93 8.04 17.62 12 18v2h-4v2h8v-2h-4v-2c3.96-.38 7-4.07 7-8.5V8.34c0-.09-.04-.17-.1-.24-.06-.06-.13-.1-.21-.1z"/></svg> üé§ Start Recording';
            document.getElementById('recording-status').textContent = 'Recording complete!';
            document.getElementById('recording-timer').classList.add('hidden');
        }
    }
    
    function updateRecordingTimer() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('recording-timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    async function analyzeVoice() {
        if (recordedChunks.length === 0) {
            alert('Please record audio first');
            return;
        }
        
        showLoading();
        
        try {
            const audioBlob = new Blob(recordedChunks, { type: 'audio/wav' });
            const formData = new FormData();
            formData.append('audio', audioBlob, 'emotion_recording.wav');
            
            const response = await fetch('/api/emotion/analyze', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayEnhancedResults(result.emotion_result, 'voice');
            } else {
                throw new Error(result.error || 'Analysis failed');
            }
            
        } catch (error) {
            console.error('Voice analysis error:', error);
            alert('Analysis failed: ' + error.message);
            hideLoading();
        }
    }
    
    function retryRecording() {
        document.getElementById('audio-preview').classList.add('hidden');
        recordedChunks = [];
    }
    
    // Camera Analysis Functions
    async function toggleCamera() {
        if (cameraStream) {
            stopCamera();
        } else {
            startCamera();
        }
    }
    
    async function startCamera() {
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 },
                    facingMode: 'user'
                } 
            });
            
            const video = document.getElementById('camera-feed');
            const placeholder = document.getElementById('camera-placeholder');
            
            video.srcObject = cameraStream;
            video.classList.remove('hidden');
            placeholder.classList.add('hidden');
            
            await video.play();
            
            // Update UI
            document.getElementById('camera-button').innerHTML = '<svg class="svg-icon inline mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg> ‚èπÔ∏è Stop Camera';
            document.getElementById('capture-button').classList.remove('hidden');
            document.getElementById('camera-status').textContent = 'Camera active - position your face in the frame';
            
        } catch (error) {
            console.error('Error accessing camera:', error);
            alert('Unable to access camera. Please check permissions and try again.');
        }
    }
    
    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
            
            const video = document.getElementById('camera-feed');
            const placeholder = document.getElementById('camera-placeholder');
            
            video.classList.add('hidden');
            placeholder.classList.remove('hidden');
            
            // Update UI
            document.getElementById('camera-button').innerHTML = '<svg class="svg-icon inline mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M9 3L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2h-3.17L15 3H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-9l1.25 2.75L16 13l-2.75 1.25L12 17l-1.25-2.75L8 13l2.75-1.25L12 9z"/></svg> üìπ Start Camera';
            document.getElementById('capture-button').classList.add('hidden');
            document.getElementById('camera-status').textContent = 'Click the button below to start camera';
        }
    }
    
    async function captureAndAnalyze() {
        if (!cameraStream) {
            alert('Please start the camera first');
            return;
        }
        
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('capture-canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        // Convert to blob for upload
        canvas.toBlob(async function(blob) {
            capturedPhotoBlob = blob;
            
            // Stop camera after capture
            stopCamera();
            
            // Show loading and analyze
            showLoading();
            
            try {
                const formData = new FormData();
                formData.append('image', blob, 'emotion_capture.jpg');
                
                const response = await fetch('/api/emotion/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayEnhancedResults(result.emotion_result, 'facial');
                } else {
                    throw new Error(result.error || 'Analysis failed');
                }
                
            } catch (error) {
                console.error('Facial analysis error:', error);
                alert('Analysis failed: ' + error.message);
                hideLoading();
            }
        }, 'image/jpeg', 0.8);
    }
    
    // Enhanced Results Display
    function displayEnhancedResults(emotionResult, analysisType) {
        hideLoading();
        
        const resultsSection = document.getElementById('results-section');
        resultsSection.classList.remove('hidden');
        resultsSection.scrollIntoView({ behavior: 'smooth' });
        
        // Primary emotion
        const primaryEmotion = emotionResult.primary_emotion || 'neutral';
        const intensity = emotionResult.emotion_intensity || 5;
        const confidence = Math.round((emotionResult.confidence || 0.5) * 100);
        
        document.getElementById('emotion-emoji').textContent = emotionEmojis[primaryEmotion] || 'üòê';
        document.getElementById('emotion-name').textContent = primaryEmotion.charAt(0).toUpperCase() + primaryEmotion.slice(1);
        document.getElementById('intensity-value').textContent = `${intensity}/10`;
        document.getElementById('confidence-value').textContent = `${confidence}%`;
        
        // Update intensity bar
        const intensityBar = document.getElementById('intensity-bar');
        intensityBar.style.width = `${(intensity / 10) * 100}%`;
        intensityBar.className = `h-3 rounded-full ${intensity >= 7 ? 'bg-red-500' : intensity >= 4 ? 'bg-yellow-500' : 'bg-green-500'}`;
        
        // Emotion breakdown
        const breakdownContainer = document.getElementById('emotion-breakdown');
        if (emotionResult.emotions_breakdown || emotionResult.emotions) {
            const emotions = emotionResult.emotions_breakdown || emotionResult.emotions || {};
            breakdownContainer.innerHTML = '';
            
            Object.entries(emotions).forEach(([emotion, score]) => {
                const emotionCard = document.createElement('div');
                emotionCard.className = 'bg-gray-50 rounded-lg p-4 text-center';
                emotionCard.innerHTML = `
                    <div class="text-2xl mb-2">${emotionEmojis[emotion] || 'üòê'}</div>
                    <div class="text-sm font-semibold text-gray-900">${emotion.charAt(0).toUpperCase() + emotion.slice(1)}</div>
                    <div class="text-lg font-bold text-blue-600">${Math.round(score)}%</div>
                `;
                breakdownContainer.appendChild(emotionCard);
            });
        }
        
        // Detailed insights
        const insightsContainer = document.getElementById('detailed-insights');
        let insights = '';
        
        if (emotionResult.facial_features_analysis) {
            const features = emotionResult.facial_features_analysis;
            insights += `<div class="mb-4"><h5 class="font-semibold mb-2">Facial Analysis:</h5>`;
            insights += `<p class="text-sm mb-1"><strong>Eyes:</strong> ${features.eye_expression || 'Normal expression'}</p>`;
            insights += `<p class="text-sm mb-1"><strong>Mouth:</strong> ${features.mouth_expression || 'Neutral positioning'}</p>`;
            insights += `<p class="text-sm"><strong>Overall:</strong> ${features.overall_tension || 'Relaxed state'}</p></div>`;
        }
        
        if (emotionResult.mental_health_indicators && emotionResult.mental_health_indicators.length > 0) {
            insights += `<div><h5 class="font-semibold mb-2">Wellness Indicators:</h5>`;
            insights += `<ul class="text-sm list-disc list-inside">`;
            emotionResult.mental_health_indicators.forEach(indicator => {
                insights += `<li>${indicator}</li>`;
            });
            insights += `</ul></div>`;
        }
        
        if (emotionResult.analysis_method) {
            insights += `<div class="mt-4"><h5 class="font-semibold mb-2">Analysis Method:</h5>`;
            insights += `<p class="text-sm">${emotionResult.analysis_method.replace(/_/g, ' ').toUpperCase()}</p></div>`;
        }
        
        insightsContainer.innerHTML = insights || '<p class="text-blue-800">Your emotional state appears balanced and healthy.</p>';
        
        // Recommendations
        const recommendationsContainer = document.getElementById('recommendations');
        const recommendations = emotionResult.recommendations || 'Take some time for self-care and mindfulness practices.';
        recommendationsContainer.innerHTML = `<p class="text-green-800">${recommendations}</p>`;
        
        // Cultural context
        const culturalContainer = document.getElementById('cultural-insights');
        const culturalContext = emotionResult.cultural_context || emotionResult.cultural_considerations || 'Your emotional expression is understood within Indian cultural context.';
        culturalContainer.innerHTML = `<p class="text-purple-800">${culturalContext}</p>`;
    }
    
    // Utility Functions
    function showLoading() {
        document.getElementById('loading-section').classList.remove('hidden');
        document.getElementById('results-section').classList.add('hidden');
        document.getElementById('loading-section').scrollIntoView({ behavior: 'smooth' });
    }
    
    function hideLoading() {
        document.getElementById('loading-section').classList.add('hidden');
    }
    
    function getTherapyRecommendations() {
        // Redirect to therapy session page
        window.location.href = '/therapy-session';
    }
    
    function saveResults() {
        alert('Results saved to your dashboard for progress tracking!');
    }
    
    function startNewAnalysis() {
        // Reset all interfaces
        document.getElementById('results-section').classList.add('hidden');
        document.getElementById('analysis-interface').classList.add('hidden');
        
        // Reset forms
        document.getElementById('emotion-text').value = '';
        
        // Reset voice
        document.getElementById('audio-preview').classList.add('hidden');
        recordedChunks = [];
        
        // Reset camera
        if (cameraStream) {
            stopCamera();
        }
        
        // Reset variables
        capturedPhotoBlob = null;
        currentAnalysisType = null;
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Enhanced Emotion Analysis page loaded with backed up UI');
    });
</script>
{% endblock %}