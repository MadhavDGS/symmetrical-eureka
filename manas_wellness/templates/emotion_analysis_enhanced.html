{% extends "base.html" %}

{% block title %}Emotion Analysis - Aarohan{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-blue-50 to-white py-8">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="flex items-center justify-center mb-4">
                <img src="{{ url_for('static', filename='aarohan-logo.png') }}" alt="Aarohan" class="w-12 h-12 mr-3">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">
                    Emotion Analysis
                </h1>
            </div>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                Share your feelings through different ways. Our advanced AI will analyze your emotional state 
                and provide personalized insights and support.
            </p>
        </div>
        
        <!-- Analysis Methods Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
            <!-- Camera Analysis -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 text-white">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mr-4">
                            <span class="text-2xl">üì∏</span>
                        </div>
                        <h3 class="text-xl font-bold">Facial Analysis</h3>
                    </div>
                    <p class="text-green-100">
                        Take a photo and let our enhanced AI analyze your facial expressions for emotional insights.
                    </p>
                </div>
                
                <div class="p-6">
                    <div id="camera-section">
                        <!-- Camera Preview -->
                        <div class="mb-6">
                            <video id="camera-preview" class="w-full rounded-lg border-2 border-dashed border-gray-300" style="display: none;"></video>
                            <canvas id="photo-canvas" class="w-full rounded-lg border-2 border-gray-300" style="display: none;"></canvas>
                            <div id="photo-placeholder" class="w-full h-48 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center">
                                <div class="text-center">
                                    <span class="text-4xl mb-2 block">üì∑</span>
                                    <p class="text-gray-500">Click below to start camera</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Camera Controls -->
                        <div class="flex flex-col gap-3">
                            <button id="start-camera" onclick="startCamera()" 
                                    class="bg-green-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                                üìπ Start Camera
                            </button>
                            <button id="capture-photo" onclick="capturePhoto()" 
                                    class="bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors" 
                                    style="display: none;">
                                üì∏ Capture Photo
                            </button>
                            <button id="analyze-photo" onclick="analyzePhoto()" 
                                    class="bg-purple-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors" 
                                    style="display: none;">
                                üß† Analyze Emotions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Text Analysis -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 text-white">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mr-4">
                            <span class="text-2xl">‚úçÔ∏è</span>
                        </div>
                        <h3 class="text-xl font-bold">Text Analysis</h3>
                    </div>
                    <p class="text-blue-100">
                        Write about your feelings and thoughts. Our AI will understand the emotions in your words.
                    </p>
                </div>
                
                <div class="p-6">
                    <div class="mb-6">
                        <label for="emotion-text" class="block text-sm font-medium text-gray-700 mb-2">
                            How are you feeling today?
                        </label>
                        <textarea id="emotion-text" 
                                  rows="6" 
                                  class="w-full p-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                                  placeholder="I'm feeling... Today has been... I'm worried about... I'm excited because..."></textarea>
                    </div>
                    
                    <div class="flex flex-col gap-3">
                        <button onclick="analyzeText()" 
                                class="bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                            üß† Analyze Text
                        </button>
                        <button onclick="clearText()" 
                                class="bg-gray-500 text-white px-4 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                            üóëÔ∏è Clear Text
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Voice Analysis -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-6 text-white">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mr-4">
                            <span class="text-2xl">üé§</span>
                        </div>
                        <h3 class="text-xl font-bold">Voice Analysis</h3>
                    </div>
                    <p class="text-purple-100">
                        Record your voice to analyze emotional patterns in your speech and tone.
                    </p>
                </div>
                
                <div class="p-6">
                    <div class="mb-6">
                        <div id="audio-visualizer" class="w-full h-24 bg-gray-100 rounded-lg border-2 border-gray-300 flex items-center justify-center">
                            <div class="text-center">
                                <span class="text-3xl mb-2 block">üéµ</span>
                                <p class="text-gray-500 text-sm">Ready to record</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-3">
                        <button id="start-recording" onclick="startRecording()" 
                                class="bg-purple-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                            üé§ Start Recording
                        </button>
                        <button id="stop-recording" onclick="stopRecording()" 
                                class="bg-red-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-red-700 transition-colors" 
                                style="display: none;">
                            ‚èπÔ∏è Stop Recording
                        </button>
                        <button id="analyze-audio" onclick="analyzeAudio()" 
                                class="bg-green-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors" 
                                style="display: none;">
                            üß† Analyze Voice
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="results-section" class="bg-white rounded-2xl shadow-lg p-8" style="display: none;">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Analysis Results</h2>
                <p class="text-gray-600">Here's what our AI found about your emotional state</p>
            </div>
            
            <!-- Primary Emotion Display -->
            <div id="primary-emotion" class="text-center mb-8">
                <div class="w-32 h-32 bg-gray-200 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <span id="emotion-emoji" class="text-6xl">üòä</span>
                </div>
                <h3 id="emotion-name" class="text-3xl font-bold text-gray-900 mb-2">Happy</h3>
                <div class="flex items-center justify-center mb-4">
                    <span class="text-sm text-gray-600 mr-2">Intensity:</span>
                    <div class="w-48 bg-gray-200 rounded-full h-3">
                        <div id="intensity-bar" class="bg-green-500 h-3 rounded-full" style="width: 70%"></div>
                    </div>
                    <span id="intensity-value" class="text-sm text-gray-600 ml-2">7/10</span>
                </div>
                <div class="flex items-center justify-center">
                    <span class="text-sm text-gray-600 mr-2">Confidence:</span>
                    <span id="confidence-value" class="text-sm font-semibold text-green-600">85%</span>
                </div>
            </div>
            
            <!-- Emotion Breakdown -->
            <div id="emotion-breakdown" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <!-- Detailed Analysis -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Insights -->
                <div class="bg-blue-50 rounded-xl p-6">
                    <h4 class="text-lg font-semibold text-blue-900 mb-4">üîç Detailed Insights</h4>
                    <div id="detailed-insights">
                        <p class="text-blue-800">Analysis will appear here...</p>
                    </div>
                </div>
                
                <!-- Recommendations -->
                <div class="bg-green-50 rounded-xl p-6">
                    <h4 class="text-lg font-semibold text-green-900 mb-4">üí° Recommendations</h4>
                    <div id="recommendations">
                        <p class="text-green-800">Personalized recommendations will appear here...</p>
                    </div>
                </div>
            </div>
            
            <!-- Cultural Context -->
            <div id="cultural-context" class="bg-purple-50 rounded-xl p-6 mt-8">
                <h4 class="text-lg font-semibold text-purple-900 mb-4">üåè Cultural Considerations</h4>
                <div id="cultural-insights">
                    <p class="text-purple-800">Cultural context will be provided here...</p>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 mt-8 pt-8 border-t border-gray-200">
                <a href="/therapy-session" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors text-center">
                    üßò Start Therapy Session
                </a>
                <a href="/analytics" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-center">
                    üìä View Progress
                </a>
                <button onclick="saveResults()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                    üíæ Save Results
                </button>
                <button onclick="resetAnalysis()" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                    üîÑ New Analysis
                </button>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="loading-section" class="text-center py-12" style="display: none;">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-green-600 mx-auto mb-4"></div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Analyzing Your Emotions...</h3>
            <p class="text-gray-600">Our AI is processing your input to provide personalized insights</p>
        </div>
    </div>
</div>

<script>
let currentStream = null;
let mediaRecorder = null;
let recordedChunks = [];
let capturedPhoto = null;

// Emotion emoji mapping
const emotionEmojis = {
    'happy': 'üòä',
    'sad': 'üò¢',
    'angry': 'üò†',
    'surprised': 'üò≤',
    'neutral': 'üòê',
    'anxious': 'üò∞',
    'confused': 'üòï',
    'excited': 'ü§©',
    'calm': 'üòå',
    'stressed': 'üò§'
};

// Camera functions
async function startCamera() {
    try {
        currentStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 640 }, 
                height: { ideal: 480 },
                facingMode: 'user'
            } 
        });
        
        const video = document.getElementById('camera-preview');
        const placeholder = document.getElementById('photo-placeholder');
        
        video.srcObject = currentStream;
        video.style.display = 'block';
        placeholder.style.display = 'none';
        
        await video.play();
        
        document.getElementById('start-camera').style.display = 'none';
        document.getElementById('capture-photo').style.display = 'block';
        
    } catch (error) {
        console.error('Error accessing camera:', error);
        alert('Unable to access camera. Please check permissions and try again.');
    }
}

function capturePhoto() {
    const video = document.getElementById('camera-preview');
    const canvas = document.getElementById('photo-canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    // Convert to blob for upload
    canvas.toBlob(function(blob) {
        capturedPhoto = blob;
    }, 'image/jpeg', 0.8);
    
    // Show canvas, hide video
    video.style.display = 'none';
    canvas.style.display = 'block';
    
    // Stop camera stream
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
    }
    
    document.getElementById('capture-photo').style.display = 'none';
    document.getElementById('analyze-photo').style.display = 'block';
}

async function analyzePhoto() {
    if (!capturedPhoto) {
        alert('Please capture a photo first');
        return;
    }
    
    showLoading();
    
    try {
        const formData = new FormData();
        formData.append('image', capturedPhoto, 'emotion_capture.jpg');
        
        const response = await fetch('/api/emotion/analyze', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayResults(result.emotion_result, 'facial');
        } else {
            throw new Error(result.error || 'Analysis failed');
        }
        
    } catch (error) {
        console.error('Photo analysis error:', error);
        alert('Analysis failed: ' + error.message);
        hideLoading();
    }
}

// Text analysis
async function analyzeText() {
    const text = document.getElementById('emotion-text').value.trim();
    
    if (!text) {
        alert('Please enter some text to analyze');
        return;
    }
    
    showLoading();
    
    try {
        const response = await fetch('/api/emotion/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ text: text })
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayResults(result.emotion_result, 'text');
        } else {
            throw new Error(result.error || 'Analysis failed');
        }
        
    } catch (error) {
        console.error('Text analysis error:', error);
        alert('Analysis failed: ' + error.message);
        hideLoading();
    }
}

function clearText() {
    document.getElementById('emotion-text').value = '';
}

// Voice recording functions
async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];
        
        mediaRecorder.ondataavailable = function(event) {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = function() {
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        
        document.getElementById('start-recording').style.display = 'none';
        document.getElementById('stop-recording').style.display = 'block';
        
        // Update visualizer
        const visualizer = document.getElementById('audio-visualizer');
        visualizer.innerHTML = '<div class="text-center"><span class="text-3xl mb-2 block animate-pulse">üî¥</span><p class="text-red-600 text-sm font-semibold">Recording...</p></div>';
        
    } catch (error) {
        console.error('Error starting recording:', error);
        alert('Unable to access microphone. Please check permissions and try again.');
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        
        document.getElementById('stop-recording').style.display = 'none';
        document.getElementById('analyze-audio').style.display = 'block';
        
        // Update visualizer
        const visualizer = document.getElementById('audio-visualizer');
        visualizer.innerHTML = '<div class="text-center"><span class="text-3xl mb-2 block">‚úÖ</span><p class="text-green-600 text-sm font-semibold">Recording complete</p></div>';
    }
}

async function analyzeAudio() {
    if (recordedChunks.length === 0) {
        alert('Please record audio first');
        return;
    }
    
    showLoading();
    
    try {
        const audioBlob = new Blob(recordedChunks, { type: 'audio/wav' });
        const formData = new FormData();
        formData.append('audio', audioBlob, 'emotion_recording.wav');
        
        const response = await fetch('/api/emotion/analyze', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayResults(result.emotion_result, 'voice');
        } else {
            throw new Error(result.error || 'Analysis failed');
        }
        
    } catch (error) {
        console.error('Audio analysis error:', error);
        alert('Analysis failed: ' + error.message);
        hideLoading();
    }
}

// Results display
function displayResults(emotionResult, analysisType) {
    hideLoading();
    
    const resultsSection = document.getElementById('results-section');
    resultsSection.style.display = 'block';
    resultsSection.scrollIntoView({ behavior: 'smooth' });
    
    // Primary emotion
    const primaryEmotion = emotionResult.primary_emotion || 'neutral';
    const intensity = emotionResult.emotion_intensity || 5;
    const confidence = Math.round((emotionResult.confidence || 0.5) * 100);
    
    document.getElementById('emotion-emoji').textContent = emotionEmojis[primaryEmotion] || 'üòê';
    document.getElementById('emotion-name').textContent = primaryEmotion.charAt(0).toUpperCase() + primaryEmotion.slice(1);
    document.getElementById('intensity-value').textContent = `${intensity}/10`;
    document.getElementById('confidence-value').textContent = `${confidence}%`;
    
    // Update intensity bar
    const intensityBar = document.getElementById('intensity-bar');
    intensityBar.style.width = `${(intensity / 10) * 100}%`;
    intensityBar.className = `h-3 rounded-full ${intensity >= 7 ? 'bg-red-500' : intensity >= 4 ? 'bg-yellow-500' : 'bg-green-500'}`;
    
    // Emotion breakdown
    const breakdownContainer = document.getElementById('emotion-breakdown');
    if (emotionResult.emotions_breakdown || emotionResult.emotions) {
        const emotions = emotionResult.emotions_breakdown || emotionResult.emotions || {};
        breakdownContainer.innerHTML = '';
        
        Object.entries(emotions).forEach(([emotion, score]) => {
            const emotionCard = document.createElement('div');
            emotionCard.className = 'bg-gray-50 rounded-lg p-4 text-center';
            emotionCard.innerHTML = `
                <div class="text-2xl mb-2">${emotionEmojis[emotion] || 'üòê'}</div>
                <div class="text-sm font-semibold text-gray-900">${emotion.charAt(0).toUpperCase() + emotion.slice(1)}</div>
                <div class="text-lg font-bold text-blue-600">${Math.round(score)}%</div>
            `;
            breakdownContainer.appendChild(emotionCard);
        });
    }
    
    // Detailed insights
    const insightsContainer = document.getElementById('detailed-insights');
    let insights = '';
    
    if (emotionResult.facial_features_analysis) {
        const features = emotionResult.facial_features_analysis;
        insights += `<div class="mb-4"><h5 class="font-semibold mb-2">Facial Analysis:</h5>`;
        insights += `<p class="text-sm mb-1"><strong>Eyes:</strong> ${features.eye_expression || 'Normal expression'}</p>`;
        insights += `<p class="text-sm mb-1"><strong>Mouth:</strong> ${features.mouth_expression || 'Neutral positioning'}</p>`;
        insights += `<p class="text-sm"><strong>Overall:</strong> ${features.overall_tension || 'Relaxed state'}</p></div>`;
    }
    
    if (emotionResult.mental_health_indicators && emotionResult.mental_health_indicators.length > 0) {
        insights += `<div><h5 class="font-semibold mb-2">Wellness Indicators:</h5>`;
        insights += `<ul class="text-sm list-disc list-inside">`;
        emotionResult.mental_health_indicators.forEach(indicator => {
            insights += `<li>${indicator}</li>`;
        });
        insights += `</ul></div>`;
    }
    
    insightsContainer.innerHTML = insights || '<p class="text-blue-800">Your emotional state appears balanced.</p>';
    
    // Recommendations
    const recommendationsContainer = document.getElementById('recommendations');
    const recommendations = emotionResult.recommendations || 'Take some time for self-care and mindfulness.';
    recommendationsContainer.innerHTML = `<p class="text-green-800">${recommendations}</p>`;
    
    // Cultural context
    const culturalContainer = document.getElementById('cultural-insights');
    const culturalContext = emotionResult.cultural_context || emotionResult.cultural_considerations || 'Your emotional expression is understood within cultural context.';
    culturalContainer.innerHTML = `<p class="text-purple-800">${culturalContext}</p>`;
}

// Utility functions
function showLoading() {
    document.getElementById('loading-section').style.display = 'block';
    document.getElementById('results-section').style.display = 'none';
    document.getElementById('loading-section').scrollIntoView({ behavior: 'smooth' });
}

function hideLoading() {
    document.getElementById('loading-section').style.display = 'none';
}

function resetAnalysis() {
    // Hide results
    document.getElementById('results-section').style.display = 'none';
    
    // Reset camera
    const video = document.getElementById('camera-preview');
    const canvas = document.getElementById('photo-canvas');
    const placeholder = document.getElementById('photo-placeholder');
    
    video.style.display = 'none';
    canvas.style.display = 'none';
    placeholder.style.display = 'flex';
    
    document.getElementById('start-camera').style.display = 'block';
    document.getElementById('capture-photo').style.display = 'none';
    document.getElementById('analyze-photo').style.display = 'none';
    
    // Reset audio
    document.getElementById('start-recording').style.display = 'block';
    document.getElementById('stop-recording').style.display = 'none';
    document.getElementById('analyze-audio').style.display = 'none';
    
    const visualizer = document.getElementById('audio-visualizer');
    visualizer.innerHTML = '<div class="text-center"><span class="text-3xl mb-2 block">üéµ</span><p class="text-gray-500 text-sm">Ready to record</p></div>';
    
    // Clear text
    document.getElementById('emotion-text').value = '';
    
    // Reset variables
    capturedPhoto = null;
    recordedChunks = [];
    
    // Stop any active streams
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
    }
}

function saveResults() {
    // Implementation for saving results
    alert('Results saved to your profile for tracking progress over time.');
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Enhanced Emotion Analysis page loaded');
});
</script>
{% endblock %}
