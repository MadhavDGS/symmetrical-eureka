{% extends "base.html" %}

{% block title %}Fitness Tracker - Aarohan{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header Section -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
            üíì Fitness & Health Tracker
        </h1>
        <p class="text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
            Monitor your vital signs, track fitness activities, and maintain optimal health
        </p>
    </div>

    <!-- Real-time Health Metrics Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- Heart Rate -->
        <div class="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-lg text-center">
            <div class="flex items-center justify-center mb-3">
                <div class="w-12 h-12 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center">
                    <span class="text-2xl">‚ù§Ô∏è</span>
                </div>
            </div>
            <div class="text-3xl font-bold text-red-600 mb-1" id="heartRate">72</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">BPM</div>
            <div class="text-xs text-green-600 mt-1" id="heartRateStatus">Normal</div>
        </div>

        <!-- SpO2 (Blood Oxygen) -->
        <div class="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-lg text-center">
            <div class="flex items-center justify-center mb-3">
                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                    <span class="text-2xl">ü´Å</span>
                </div>
            </div>
            <div class="text-3xl font-bold text-blue-600 mb-1" id="spo2">98</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">%</div>
            <div class="text-xs text-green-600 mt-1" id="spo2Status">Excellent</div>
        </div>

        <!-- Blood Pressure -->
        <div class="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-lg text-center">
            <div class="flex items-center justify-center mb-3">
                <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-full flex items-center justify-center">
                    <span class="text-2xl">ü©∫</span>
                </div>
            </div>
            <div class="text-2xl font-bold text-purple-600 mb-1" id="bloodPressure">120/80</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">mmHg</div>
            <div class="text-xs text-green-600 mt-1" id="bpStatus">Optimal</div>
        </div>

        <!-- Body Temperature -->
        <div class="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-lg text-center">
            <div class="flex items-center justify-center mb-3">
                <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-full flex items-center justify-center">
                    <span class="text-2xl">üå°Ô∏è</span>
                </div>
            </div>
            <div class="text-3xl font-bold text-orange-600 mb-1" id="temperature">98.6</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">¬∞F</div>
            <div class="text-xs text-green-600 mt-1" id="tempStatus">Normal</div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Real-time Monitoring -->
        <div class="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                üìä Real-time Health Monitoring
            </h2>
            
            <!-- Monitoring Controls -->
            <div class="flex justify-center space-x-4 mb-6">
                <button id="startMonitoring" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                    Start Monitoring
                </button>
                <button id="stopMonitoring" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium" disabled>
                    Stop Monitoring
                </button>
                <button id="syncData" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                    Sync with Google Fit
                </button>
            </div>

            <!-- Live Chart Container -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 h-64 mb-4">
                <div class="flex items-center justify-center h-full">
                    <div id="healthChart" class="w-full h-full">
                        <canvas id="vitalsChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Current Session Info -->
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="text-center">
                    <div class="font-medium text-gray-700 dark:text-gray-300">Session Duration</div>
                    <div class="text-lg font-bold text-blue-600" id="sessionDuration">00:00</div>
                </div>
                <div class="text-center">
                    <div class="font-medium text-gray-700 dark:text-gray-300">Data Points</div>
                    <div class="text-lg font-bold text-green-600" id="dataPoints">0</div>
                </div>
            </div>
        </div>

        <!-- Health Insights & AI Analysis -->
        <div class="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                ü§ñ AI Health Insights
            </h2>
            
            <!-- AI Analysis Results -->
            <div id="aiInsights" class="space-y-4 mb-6">
                <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                    <h3 class="font-medium text-green-800 dark:text-green-300 mb-2">‚úÖ Overall Health Status</h3>
                    <p class="text-sm text-green-700 dark:text-green-400">Your vital signs are within normal ranges. Keep up the great work!</p>
                </div>
                
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                    <h3 class="font-medium text-blue-800 dark:text-blue-300 mb-2">üí° Recommendations</h3>
                    <ul class="text-sm text-blue-700 dark:text-blue-400 space-y-1">
                        <li>‚Ä¢ Maintain regular hydration throughout the day</li>
                        <li>‚Ä¢ Consider 30 minutes of moderate exercise</li>
                        <li>‚Ä¢ Monitor stress levels during peak hours</li>
                    </ul>
                </div>
            </div>

            <!-- Get AI Analysis Button -->
            <button id="getAiAnalysis" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg font-medium mb-4">
                üß† Get AI Health Analysis
            </button>

            <!-- Health Trends -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                <h3 class="font-medium text-gray-900 dark:text-white mb-3">üìà 24-Hour Trends</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Avg Heart Rate:</span>
                        <span class="font-medium text-red-600">74 BPM</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Avg SpO2:</span>
                        <span class="font-medium text-blue-600">97.8%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Resting HR:</span>
                        <span class="font-medium text-green-600">68 BPM</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Max HR Today:</span>
                        <span class="font-medium text-orange-600">95 BPM</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fitness Activities -->
        <div class="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                üèÉ‚Äç‚ôÇÔ∏è Fitness Activities
            </h2>

            <!-- Activity Selection -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button class="activity-btn bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 p-3 rounded-lg text-sm font-medium hover:bg-blue-200 dark:hover:bg-blue-800" data-activity="walking">
                    üö∂‚Äç‚ôÇÔ∏è Walking
                </button>
                <button class="activity-btn bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 p-3 rounded-lg text-sm font-medium hover:bg-green-200 dark:hover:bg-green-800" data-activity="running">
                    üèÉ‚Äç‚ôÇÔ∏è Running
                </button>
                <button class="activity-btn bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 p-3 rounded-lg text-sm font-medium hover:bg-purple-200 dark:hover:bg-purple-800" data-activity="cycling">
                    üö¥‚Äç‚ôÇÔ∏è Cycling
                </button>
                <button class="activity-btn bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200 p-3 rounded-lg text-sm font-medium hover:bg-orange-200 dark:hover:bg-orange-800" data-activity="yoga">
                    üßò‚Äç‚ôÄÔ∏è Yoga
                </button>
            </div>

            <!-- Current Activity -->
            <div id="currentActivity" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                <h3 class="font-medium text-gray-900 dark:text-white mb-3">Current Activity: <span id="activityName">None</span></h3>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <div class="text-lg font-bold text-blue-600" id="duration">00:00</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">Duration</div>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-green-600" id="calories">0</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">Calories</div>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-purple-600" id="distance">0.0</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">km</div>
                    </div>
                </div>
            </div>

            <!-- Activity Controls -->
            <div class="flex space-x-3">
                <button id="startActivity" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium" disabled>
                    Start Activity
                </button>
                <button id="stopActivity" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-medium" disabled>
                    Stop Activity
                </button>
            </div>
        </div>

        <!-- Health Goals & Progress -->
        <div class="bg-white dark:bg-dark-800 rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                üéØ Health Goals & Progress
            </h2>

            <!-- Daily Goals -->
            <div class="space-y-4 mb-6">
                <!-- Steps Goal -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Daily Steps</span>
                        <span class="text-sm text-blue-600" id="stepsProgress">6,500 / 10,000</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: 65%" id="stepsBar"></div>
                    </div>
                </div>

                <!-- Heart Rate Zone Goal -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Heart Rate Zone Time</span>
                        <span class="text-sm text-red-600" id="hrZoneProgress">25 / 30 min</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div class="bg-red-600 h-2 rounded-full" style="width: 83%" id="hrZoneBar"></div>
                    </div>
                </div>

                <!-- Active Calories Goal -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Active Calories</span>
                        <span class="text-sm text-green-600" id="caloriesProgress">420 / 500 kcal</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" style="width: 84%" id="caloriesBar"></div>
                    </div>
                </div>
            </div>

            <!-- Weekly Challenge -->
            <div class="bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900 dark:to-pink-900 rounded-lg p-4">
                <h3 class="font-medium text-purple-800 dark:text-purple-200 mb-2">üèÜ Weekly Challenge</h3>
                <p class="text-sm text-purple-700 dark:text-purple-300 mb-3">Maintain SpO2 above 95% for 7 consecutive days</p>
                <div class="flex space-x-1">
                    <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                        <span class="text-xs text-white">‚úì</span>
                    </div>
                    <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                        <span class="text-xs text-white">‚úì</span>
                    </div>
                    <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                        <span class="text-xs text-white">‚úì</span>
                    </div>
                    <div class="w-6 h-6 bg-purple-300 rounded-full flex items-center justify-center">
                        <span class="text-xs text-purple-600">4</span>
                    </div>
                    <div class="w-6 h-6 bg-gray-300 rounded-full"></div>
                    <div class="w-6 h-6 bg-gray-300 rounded-full"></div>
                    <div class="w-6 h-6 bg-gray-300 rounded-full"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency Alert Modal (Hidden by default) -->
    <div id="emergencyModal" class="hidden fixed inset-0 bg-red-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md mx-4 text-center">
            <div class="text-6xl mb-4">üö®</div>
            <h3 class="text-xl font-bold text-red-600 mb-4">Health Alert!</h3>
            <p class="text-gray-700 dark:text-gray-300 mb-6" id="alertMessage">Abnormal vital signs detected.</p>
            <div class="space-y-3">
                <button id="callEmergency" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-medium">
                    üìû Call Emergency Services
                </button>
                <button id="dismissAlert" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg font-medium">
                    Dismiss Alert
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Fitness Tracker JavaScript
class FitnessTracker {
    constructor() {
        this.isMonitoring = false;
        this.currentActivity = null;
        this.sessionStartTime = null;
        this.activityStartTime = null;
        this.dataPoints = 0;
        this.healthData = [];
        this.googleApiKey = 'AIzaSyCqS7EtO9ZSPyAOTN41HV9xofPK-rwDIL4';
        
        // Health ranges
        this.healthRanges = {
            heartRate: { min: 60, max: 100, ideal: { min: 70, max: 85 } },
            spo2: { min: 95, max: 100, ideal: { min: 97, max: 100 } },
            systolic: { min: 90, max: 120, ideal: { min: 110, max: 120 } },
            diastolic: { min: 60, max: 80, ideal: { min: 70, max: 80 } },
            temperature: { min: 97.0, max: 99.5, ideal: { min: 98.0, max: 99.0 } }
        };
        
        this.initializeEventListeners();
        this.updateDisplay();
        console.log('Fitness Tracker initialized with Google API integration');
    }

    initializeEventListeners() {
        // Monitoring controls
        document.getElementById('startMonitoring')?.addEventListener('click', () => this.startMonitoring());
        document.getElementById('stopMonitoring')?.addEventListener('click', () => this.stopMonitoring());
        document.getElementById('syncData')?.addEventListener('click', () => this.syncWithGoogleFit());
        
        // AI Analysis
        document.getElementById('getAiAnalysis')?.addEventListener('click', () => this.getAiHealthAnalysis());
        
        // Activity controls
        document.querySelectorAll('.activity-btn').forEach(btn => {
            btn.addEventListener('click', (e) => this.selectActivity(e.target.dataset.activity));
        });
        document.getElementById('startActivity')?.addEventListener('click', () => this.startActivity());
        document.getElementById('stopActivity')?.addEventListener('click', () => this.stopActivity());
        
        // Emergency modal
        document.getElementById('dismissAlert')?.addEventListener('click', () => this.dismissEmergencyAlert());
        document.getElementById('callEmergency')?.addEventListener('click', () => this.callEmergencyServices());
    }

    startMonitoring() {
        this.isMonitoring = true;
        this.sessionStartTime = Date.now();
        this.dataPoints = 0;
        
        document.getElementById('startMonitoring').disabled = true;
        document.getElementById('stopMonitoring').disabled = false;
        
        // Start real-time data simulation
        this.monitoringInterval = setInterval(() => {
            this.updateVitalSigns();
            this.checkForAnomalies();
            this.updateSessionInfo();
        }, 2000); // Update every 2 seconds
        
        this.showToast('üü¢ Health monitoring started');
        console.log('Health monitoring started');
    }

    stopMonitoring() {
        this.isMonitoring = false;
        clearInterval(this.monitoringInterval);
        
        document.getElementById('startMonitoring').disabled = false;
        document.getElementById('stopMonitoring').disabled = true;
        
        this.showToast('üî¥ Health monitoring stopped');
        console.log('Health monitoring stopped');
    }

    updateVitalSigns() {
        // Simulate realistic vital signs with some randomness
        const baseHeartRate = this.currentActivity ? this.getActivityHeartRate() : 72;
        const heartRate = this.addRealisticVariation(baseHeartRate, 5);
        
        const baseSpo2 = 98;
        const spo2 = this.addRealisticVariation(baseSpo2, 1);
        
        const systolic = this.addRealisticVariation(120, 8);
        const diastolic = this.addRealisticVariation(80, 5);
        
        const temperature = this.addRealisticVariation(98.6, 0.3);
        
        // Update display
        document.getElementById('heartRate').textContent = Math.round(heartRate);
        document.getElementById('spo2').textContent = Math.round(spo2);
        document.getElementById('bloodPressure').textContent = `${Math.round(systolic)}/${Math.round(diastolic)}`;
        document.getElementById('temperature').textContent = temperature.toFixed(1);
        
        // Update status
        this.updateVitalStatus('heartRate', heartRate);
        this.updateVitalStatus('spo2', spo2);
        this.updateVitalStatus('bloodPressure', { systolic, diastolic });
        this.updateVitalStatus('temperature', temperature);
        
        // Store data point
        this.healthData.push({
            timestamp: Date.now(),
            heartRate: Math.round(heartRate),
            spo2: Math.round(spo2),
            systolic: Math.round(systolic),
            diastolic: Math.round(diastolic),
            temperature: temperature.toFixed(1),
            activity: this.currentActivity
        });
        
        this.dataPoints++;
    }

    addRealisticVariation(base, range) {
        return base + (Math.random() - 0.5) * 2 * range;
    }

    getActivityHeartRate() {
        const activityMultipliers = {
            walking: 1.2,
            running: 1.8,
            cycling: 1.6,
            yoga: 1.1
        };
        return 72 * (activityMultipliers[this.currentActivity] || 1);
    }

    updateVitalStatus(type, value) {
        let status, element;
        
        switch(type) {
            case 'heartRate':
                element = document.getElementById('heartRateStatus');
                if (value >= 60 && value <= 100) {
                    status = 'Normal';
                } else if (value < 60) {
                    status = 'Low';
                } else {
                    status = 'High';
                }
                break;
                
            case 'spo2':
                element = document.getElementById('spo2Status');
                if (value >= 97) {
                    status = 'Excellent';
                } else if (value >= 95) {
                    status = 'Good';
                } else {
                    status = 'Low';
                }
                break;
                
            case 'bloodPressure':
                element = document.getElementById('bpStatus');
                if (value.systolic <= 120 && value.diastolic <= 80) {
                    status = 'Optimal';
                } else if (value.systolic <= 140 && value.diastolic <= 90) {
                    status = 'Normal';
                } else {
                    status = 'High';
                }
                break;
                
            case 'temperature':
                element = document.getElementById('tempStatus');
                if (value >= 97.0 && value <= 99.5) {
                    status = 'Normal';
                } else if (value < 97.0) {
                    status = 'Low';
                } else {
                    status = 'Fever';
                }
                break;
        }
        
        if (element) {
            element.textContent = status;
            element.className = `text-xs ${status === 'Normal' || status === 'Optimal' || status === 'Excellent' || status === 'Good' ? 'text-green-600' : 'text-red-600'} mt-1`;
        }
    }

    checkForAnomalies() {
        const currentData = this.healthData[this.healthData.length - 1];
        if (!currentData) return;
        
        let alerts = [];
        
        if (currentData.heartRate > 120 || currentData.heartRate < 50) {
            alerts.push(`Heart rate: ${currentData.heartRate} BPM`);
        }
        
        if (currentData.spo2 < 94) {
            alerts.push(`Low oxygen: ${currentData.spo2}%`);
        }
        
        if (parseFloat(currentData.temperature) > 101.0) {
            alerts.push(`High fever: ${currentData.temperature}¬∞F`);
        }
        
        if (alerts.length > 0) {
            this.showEmergencyAlert(alerts.join(', '));
        }
    }

    showEmergencyAlert(message) {
        document.getElementById('alertMessage').textContent = `Abnormal readings detected: ${message}`;
        document.getElementById('emergencyModal').classList.remove('hidden');
    }

    dismissEmergencyAlert() {
        document.getElementById('emergencyModal').classList.add('hidden');
    }

    callEmergencyServices() {
        this.showToast('üö® Emergency services contacted. Help is on the way.');
        this.dismissEmergencyAlert();
        // In a real app, this would contact actual emergency services
    }

    updateSessionInfo() {
        if (!this.sessionStartTime) return;
        
        const duration = Date.now() - this.sessionStartTime;
        const minutes = Math.floor(duration / 60000);
        const seconds = Math.floor((duration % 60000) / 1000);
        
        document.getElementById('sessionDuration').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('dataPoints').textContent = this.dataPoints;
    }

    selectActivity(activity) {
        this.currentActivity = activity;
        document.getElementById('activityName').textContent = activity.charAt(0).toUpperCase() + activity.slice(1);
        document.getElementById('startActivity').disabled = false;
        
        // Update button styles
        document.querySelectorAll('.activity-btn').forEach(btn => {
            btn.classList.remove('ring-2', 'ring-blue-500');
        });
        document.querySelector(`[data-activity="${activity}"]`).classList.add('ring-2', 'ring-blue-500');
        
        this.showToast(`üèÉ‚Äç‚ôÇÔ∏è Selected activity: ${activity}`);
    }

    startActivity() {
        if (!this.currentActivity) return;
        
        this.activityStartTime = Date.now();
        document.getElementById('startActivity').disabled = true;
        document.getElementById('stopActivity').disabled = false;
        
        // Start activity tracking
        this.activityInterval = setInterval(() => {
            this.updateActivityStats();
        }, 1000);
        
        this.showToast(`üü¢ Started ${this.currentActivity} activity`);
    }

    stopActivity() {
        clearInterval(this.activityInterval);
        document.getElementById('startActivity').disabled = false;
        document.getElementById('stopActivity').disabled = true;
        
        this.showToast(`üî¥ Stopped ${this.currentActivity} activity`);
        this.saveActivityToGoogleFit();
    }

    updateActivityStats() {
        if (!this.activityStartTime) return;
        
        const duration = Date.now() - this.activityStartTime;
        const minutes = Math.floor(duration / 60000);
        const seconds = Math.floor((duration % 60000) / 1000);
        
        // Calculate estimated calories and distance based on activity
        const activityData = {
            walking: { caloriesPerMin: 5, kmPerMin: 0.083 },
            running: { caloriesPerMin: 12, kmPerMin: 0.167 },
            cycling: { caloriesPerMin: 8, kmPerMin: 0.25 },
            yoga: { caloriesPerMin: 3, kmPerMin: 0 }
        };
        
        const data = activityData[this.currentActivity] || activityData.walking;
        const totalMinutes = duration / 60000;
        
        document.getElementById('duration').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('calories').textContent = Math.round(totalMinutes * data.caloriesPerMin);
        document.getElementById('distance').textContent = (totalMinutes * data.kmPerMin).toFixed(1);
    }

    async syncWithGoogleFit() {
        this.showToast('üîÑ Syncing with Google Fit...');
        
        try {
            // Simulate API call to Google Fit
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // In a real implementation, you would use the Google Fit API
            console.log('Syncing health data with Google API:', this.googleApiKey);
            console.log('Health data to sync:', this.healthData.slice(-10));
            
            this.showToast('‚úÖ Successfully synced with Google Fit');
        } catch (error) {
            console.error('Sync failed:', error);
            this.showToast('‚ùå Sync failed. Please try again.');
        }
    }

    async getAiHealthAnalysis() {
        this.showToast('ü§ñ Analyzing your health data...');
        
        try {
            // Simulate AI analysis using the Google API
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            const analysis = this.generateHealthInsights();
            this.displayAiInsights(analysis);
            
            this.showToast('‚úÖ AI analysis complete');
        } catch (error) {
            console.error('AI analysis failed:', error);
            this.showToast('‚ùå Analysis failed. Please try again.');
        }
    }

    generateHealthInsights() {
        const recentData = this.healthData.slice(-10);
        if (recentData.length === 0) {
            return {
                status: 'No recent data available for analysis',
                recommendations: ['Start monitoring to get personalized insights']
            };
        }
        
        const avgHeartRate = recentData.reduce((sum, d) => sum + d.heartRate, 0) / recentData.length;
        const avgSpo2 = recentData.reduce((sum, d) => sum + d.spo2, 0) / recentData.length;
        
        let status = '‚úÖ Your vital signs are within healthy ranges.';
        let recommendations = [
            '‚Ä¢ Continue your current fitness routine',
            '‚Ä¢ Maintain regular hydration',
            '‚Ä¢ Ensure 7-9 hours of quality sleep'
        ];
        
        if (avgHeartRate > 90) {
            status = '‚ö†Ô∏è Your heart rate is slightly elevated.';
            recommendations = [
                '‚Ä¢ Consider stress management techniques',
                '‚Ä¢ Ensure adequate rest between activities',
                '‚Ä¢ Consult healthcare provider if persistent'
            ];
        }
        
        if (avgSpo2 < 96) {
            status = '‚ö†Ô∏è Your oxygen levels could be improved.';
            recommendations = [
                '‚Ä¢ Practice deep breathing exercises',
                '‚Ä¢ Ensure good ventilation in your space',
                '‚Ä¢ Consider cardiovascular exercise'
            ];
        }
        
        return { status, recommendations };
    }

    displayAiInsights(analysis) {
        const insightsContainer = document.getElementById('aiInsights');
        insightsContainer.innerHTML = `
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                <h3 class="font-medium text-blue-800 dark:text-blue-300 mb-2">ü§ñ AI Health Analysis</h3>
                <p class="text-sm text-blue-700 dark:text-blue-400 mb-3">${analysis.status}</p>
                <div class="text-sm text-blue-700 dark:text-blue-400">
                    <strong>Personalized Recommendations:</strong>
                    <ul class="mt-2 space-y-1">
                        ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            </div>
        `;
    }

    async saveActivityToGoogleFit() {
        if (!this.activityStartTime || !this.currentActivity) return;
        
        const activityData = {
            activity: this.currentActivity,
            startTime: this.activityStartTime,
            endTime: Date.now(),
            calories: parseInt(document.getElementById('calories').textContent),
            distance: parseFloat(document.getElementById('distance').textContent)
        };
        
        console.log('Saving activity to Google Fit:', activityData);
        // In a real app, this would use the Google Fit API
    }

    updateDisplay() {
        // Initial display setup
        this.updateSessionInfo();
    }

    showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
}

// Initialize Fitness Tracker when page loads
document.addEventListener('DOMContentLoaded', () => {
    new FitnessTracker();
});
</script>

{% endblock %}